# yaml-language-server: $schema=https://raw.githubusercontent.com/quintush/helm-unittest/master/schema/helm-testsuite.json
suite: rootless runtime test
values:
  - ../values.yaml
templates:
  - templates/hooks/post-install/job-update-runtime.yaml
  - templates/hooks/post-install/cm-update-runtime.yaml
  - templates/runtime/secret.yaml
release:
  name: cf-runtime
  namespace: codefresh
  revision: 1
  upgrade: true
chart:
  version: 1.0.0
  appVersion: 1.0.0
tests:
  - it: Test rootless runtime spec metadata
    template: templates/hooks/post-install/cm-update-runtime.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      - isNotEmpty:
          path: data["runtime.yaml"]

  - it: Test runtime spec override
    template: templates/hooks/post-install/cm-update-runtime.yaml
    set:
      runtime:
        rootless: true
    values:
      - ../values.yaml
      - ./runtime_values.yaml
    asserts:
      - matchRegex:
          path: data["runtime.yaml"]
          pattern: |
            metadata:
              name: my-context/codefresh
              agent: true
            runtimeScheduler:
              type: KubernetesPod
              image: 'quay.io/codefresh/engine:tagoverride'
              imagePullPolicy: IfNotPresent
              command:
                - npm
                - run
                - start
              envVars:
                CONTAINER_LOGGER_EXEC_CHECK_INTERVAL_MS: '1000'
                DOCKER_REQUEST_TIMEOUT_MS: '30000'
                FORCE_COMPOSE_SERIAL_PULL: 'false'
                LOGGER_LEVEL: debug
                LOG_OUTGOING_HTTP_REQUESTS: 'false'
                METRICS_PROMETHEUS_COLLECT_PROCESS_METRICS: 'false'
                METRICS_PROMETHEUS_ENABLED: 'true'
                METRICS_PROMETHEUS_ENABLE_LEGACY_METRICS: 'false'
                METRICS_PROMETHEUS_HOST: 0.0.0.0
                METRICS_PROMETHEUS_PORT: '9100'
                COMPOSE_IMAGE: 'quay.io/codefresh/compose:tagoverride'
                CONTAINER_LOGGER_IMAGE: 'quay.io/codefresh/cf-container-logger:tagoverride'
                DOCKER_BUILDER_IMAGE: 'quay.io/codefresh/cf-docker-builder:tagoverride'
                DOCKER_PULLER_IMAGE: 'quay.io/codefresh/cf-docker-puller:tagoverride'
                DOCKER_PUSHER_IMAGE: 'quay.io/codefresh/cf-docker-pusher:tagoverride'
                DOCKER_TAG_PUSHER_IMAGE: 'quay.io/codefresh/cf-docker-tag-pusher:tagoverride'
                FS_OPS_IMAGE: 'quay.io/codefresh/fs-ops:tagoverride'
                GIT_CLONE_IMAGE: 'quay.io/codefresh/cf-git-cloner:tagoverride'
                KUBE_DEPLOY: 'quay.io/codefresh/cf-deploy-kubernetes:tagoverride'
                PIPELINE_DEBUGGER_IMAGE: 'quay.io/codefresh/cf-debugger:tagoverride'
                TEMPLATE_ENGINE: 'quay.io/codefresh/pikolo:tagoverride'
                CR_6177_FIXER: 'quay.io/codefresh/alpine:edge'
                GC_BUILDER_IMAGE: 'quay.io/codefresh/cf-gc-builder:0.5.3'
              workflowLimits:
                MAXIMUM_ALLOWED_TIME_BEFORE_PRE_STEPS_SUCCESS: 600
                MAXIMUM_ALLOWED_WORKFLOW_AGE_BEFORE_TERMINATION: 86400
                MAXIMUM_ELECTED_STATE_AGE_ALLOWED: 900
                MAXIMUM_RETRY_ATTEMPTS_ALLOWED: 20
                MAXIMUM_TERMINATING_STATE_AGE_ALLOWED: 900
                MAXIMUM_TERMINATING_STATE_AGE_ALLOWED_WITHOUT_UPDATE: 300
                TIME_ENGINE_INACTIVE_UNTIL_TERMINATION: 300
                TIME_ENGINE_INACTIVE_UNTIL_UNHEALTHY: 60
                TIME_INACTIVE_UNTIL_TERMINATION: 2700
              cluster:
                namespace: codefresh
                serviceAccount: codefresh-engine
                clusterProvider:
                  accountId: 7890
                  selector: my-context
              resources:
                limits:
                  cpu: 1000m
                  memory: 2048Mi
                requests:
                  cpu: 100m
                  memory: 128Mi
            dockerDaemonScheduler:
              type: DindKubernetesPod
              dindImage: 'quay.io/codefresh/dind:tagoverride-rootless'
              imagePullPolicy: IfNotPresent
              userAccess: true
              envVars:
                DOCKER_ENABLE_DEPRECATED_PULL_SCHEMA_1_IMAGE: 'true'
              cluster:
                namespace: codefresh
                serviceAccount: codefresh-engine
                clusterProvider:
                  accountId: 7890
                  selector: my-context
              pvcs:
                - name: dind
                  reuseVolumeSelector: 'codefresh-app,io.codefresh.accountName'
                  reuseVolumeSortOrder: pipeline_id
                  storageClassName: dind-local-volumes-runner-codefresh
                  volumeSize: 16Gi
              defaultDindResources:
                limits:
                  cpu: 400m
                  memory: 800Mi
                requests: null
              userVolumeMounts:
                dind:
                  mountPath: /home/rootless/.local/share/docker/
                  name: dind
                dind-config:
                  mountPath: /home/rootless/.config/docker/daemon.json
                  name: dind-config
                  subPath: daemon.json
              podSecurityContext:
                fsGroup: 1000
              containerSecurityContext:
                privileged: true
              initContainers:
                - command:
                  - sh
                  - -c
                  - chown -R 1000:1000 /home/rootless/.local/share/docker/
                  image: docker.io/alpine:3.18
                  name: volume-permissions
                  resources: {}
                  securityContext:
                    runAsUser: 0
                  volumeMounts:
                  - mountPath: /home/rootless/.local/share/docker/
                    name: dind
            extends:
              - system/default/hybrid/k8s_low_limits
            description: null
            accountId: 7890
